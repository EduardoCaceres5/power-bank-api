// Prisma Schema for Power Bank Rental System
// Compatible with Supabase PostgreSQL

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") 
}

// ==================== USER MANAGEMENT ====================

// Usuario del sistema (Admin y usuarios regulares)
model User {
  id               String    @id @default(uuid())
  email            String    @unique
  password         String    // Hashed password
  phone            String?   @unique
  fullName         String?
  avatarUrl        String?
  role             UserRole  @default(USER)

  // Stripe
  stripeCustomerId String?   @unique

  // Estado de la cuenta
  isActive         Boolean   @default(true)
  emailVerified    Boolean   @default(false)
  lastLoginAt      DateTime?

  // Relaciones
  rentals          Rental[]
  transactions     Transaction[]
  paymentMethods   PaymentMethod[]

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  ADMIN       // Administrador del sistema
  USER        // Usuario regular
  SUPER_ADMIN // Super administrador
}

// ==================== CABINET & HARDWARE ====================

// Gabinete/Estación de carga
model Cabinet {
  id              String        @id // WSTD088888888888 (E field del protocolo)
  name            String?
  description     String?
  location        String?
  address         String?
  latitude        Float?
  longitude       Float?

  // Información técnica del protocolo WsCharge
  iotCardNumber   String?       // K field
  signalStrength  Int?          // X field (1-31)

  status          CabinetStatus @default(ONLINE)

  // Relaciones
  slots           Slot[]
  rentals         Rental[]

  lastPingAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([latitude, longitude])
  @@index([status])
  @@map("cabinets")
}

enum CabinetStatus {
  ONLINE          // Cabinet activo y funcionando
  OFFLINE         // Cabinet desconectado
  MAINTENANCE     // En mantenimiento
  OUT_OF_SERVICE  // Fuera de servicio
}

// Slot individual del gabinete
model Slot {
  id            String   @id @default(uuid())
  cabinetId     String
  slotNumber    Int      // L field (01-08 según el protocolo)

  // Relaciones
  cabinet       Cabinet  @relation(fields: [cabinetId], references: [id], onDelete: Cascade)
  powerBank     PowerBank?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([cabinetId, slotNumber])
  @@index([cabinetId])
  @@map("slots")
}

// Power Bank físico
model PowerBank {
  id            String          @id // WSBA01234567 (B field del protocolo)
  slotId        String?         @unique
  batteryLevel  Int             @default(100) // D field (0-100%)
  status        PowerBankStatus @default(AVAILABLE)

  // Información adicional
  model         String?
  serialNumber  String?         @unique

  // Relaciones
  slot          Slot?           @relation(fields: [slotId], references: [id])
  rentals       Rental[]

  // Tracking
  totalRentals  Int             @default(0)
  lastUsedAt    DateTime?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([status])
  @@map("power_banks")
}

enum PowerBankStatus {
  AVAILABLE     // Disponible para rentar
  RENTED        // Actualmente rentado
  CHARGING      // Cargando en el gabinete
  MAINTENANCE   // En mantenimiento
  LOST          // Reportado como perdido
  DAMAGED       // Dañado
}

// ==================== RENTAL MANAGEMENT ====================

// Renta de power bank
model Rental {
  id              String       @id @default(uuid())
  userId          String
  cabinetId       String
  powerBankId     String

  // Fechas
  rentedAt        DateTime     @default(now())
  returnedAt      DateTime?
  dueAt           DateTime?    // Fecha límite de devolución

  // Ubicaciones
  rentalCabinetId String       // Gabinete donde se rentó
  returnCabinetId String?      // Gabinete donde se devolvió (puede ser diferente)

  // Financiero
  basePrice       Decimal      @default(0) @db.Decimal(10, 2)
  lateFee         Decimal      @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal      @default(0) @db.Decimal(10, 2)

  status          RentalStatus @default(ACTIVE)

  // Relaciones
  user            User         @relation(fields: [userId], references: [id])
  cabinet         Cabinet      @relation(fields: [cabinetId], references: [id])
  powerBank       PowerBank    @relation(fields: [powerBankId], references: [id])
  transactions    Transaction[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([userId])
  @@index([status])
  @@index([rentedAt])
  @@map("rentals")
}

enum RentalStatus {
  ACTIVE        // Renta activa
  COMPLETED     // Devuelto exitosamente
  CANCELLED     // Cancelado
  OVERDUE       // Vencido
  LOST          // Power bank perdido
}

// ==================== PAYMENT MANAGEMENT ====================

// Transacciones de pago
model Transaction {
  id                    String            @id @default(uuid())
  userId                String
  rentalId              String?

  // Stripe
  stripePaymentIntentId String?           @unique
  stripeChargeId        String?           @unique

  // Montos
  amount                Decimal           @db.Decimal(10, 2)
  currency              String            @default("usd")

  status                TransactionStatus
  type                  TransactionType

  // Metadata
  description           String?
  metadata              Json?

  // Relaciones
  user                  User              @relation(fields: [userId], references: [id])
  rental                Rental?           @relation(fields: [rentalId], references: [id])

  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("transactions")
}

enum TransactionStatus {
  PENDING       // Pendiente
  PROCESSING    // Procesando
  COMPLETED     // Completado
  FAILED        // Fallido
  REFUNDED      // Reembolsado
  CANCELLED     // Cancelado
}

enum TransactionType {
  RENTAL        // Pago de renta
  DEPOSIT       // Depósito
  REFUND        // Reembolso
  LATE_FEE      // Cargo por retraso
  LOST_FEE      // Cargo por pérdida
}

// Métodos de pago guardados
model PaymentMethod {
  id                    String   @id @default(uuid())
  userId                String
  stripePaymentMethodId String   @unique

  // Información del método
  type                  String   // card, bank_account, etc.
  last4                 String?
  brand                 String?  // visa, mastercard, etc.
  expiryMonth           Int?
  expiryYear            Int?

  isDefault             Boolean  @default(false)

  // Relaciones
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@map("payment_methods")
}

// ==================== PRICING & CONFIGURATION ====================

// Configuración de precios
model PricingPlan {
  id              String   @id @default(uuid())
  name            String
  description     String?

  // Precios
  basePrice       Decimal  @db.Decimal(10, 2) // Precio inicial
  hourlyRate      Decimal  @db.Decimal(10, 2) // Precio por hora
  dailyRate       Decimal  @db.Decimal(10, 2) // Precio por día
  maxDailyCharge  Decimal  @db.Decimal(10, 2) // Cargo máximo diario

  // Penalizaciones
  lateFeePerhour  Decimal  @db.Decimal(10, 2)
  lostFee         Decimal  @db.Decimal(10, 2)

  // Tiempo
  gracePeriodMins Int      @default(15) // Minutos de gracia
  maxRentalDays   Int      @default(7)  // Días máximos de renta

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("pricing_plans")
}

// ==================== SYSTEM LOGS ====================

// Log de eventos del sistema
model SystemLog {
  id              String   @id @default(uuid())
  level           LogLevel
  message         String
  metadata        Json?

  // Context
  userId          String?
  cabinetId       String?
  rentalId        String?

  createdAt       DateTime @default(now())

  @@index([level])
  @@index([createdAt])
  @@map("system_logs")
}

enum LogLevel {
  INFO
  WARNING
  ERROR
  CRITICAL
}
